<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>A Simple Web App in Rust, Part 2a</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="My personal place to write about the things I find interesting. Programming, Lisp, Ruby, Emacs, etc.">
    <link rel="canonical" href="http://joelmccracken.github.io/entries/a-simple-web-app-in-rust-pt-2a/">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">

</head>

    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="/">Joel's Journal</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        <a class="page-link" href="/about">About</a>
        <a class="page-link" href="/projects">Projects</a>
      </div>
    </nav>

  </div>

</header>

    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>A Simple Web App in Rust, Part 2a</h1>
    <p class="meta">May 30, 2015</p>
  </header>

  <article class="post-content">
  <div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Context</a></li>
<li><a href="#sec-2">2. Starting Out</a></li>
<li><a href="#sec-3">3. Remembering "hello world"</a></li>
<li><a href="#sec-4">4. A Naive Approach</a></li>
<li><a href="#sec-5">5. Debugging by Expanding Macros</a></li>
<li><a href="#sec-6">6. Fighting with Types</a></li>
<li><a href="#sec-7">7. Writing to a file</a></li>
<li><a href="#sec-8">8. Updates</a></li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Context</h2>
<div class="outline-text-2" id="text-1">
<p>
If you haven't checked out part 1 of this series, I would start
<a href="http://joelmccracken.github.io/entries/a-simple-web-app-in-rust-pt-1">there</a>.
</p>

<p>
In the first part, we successfully set up the Rust project and built a
simple "hello world" web app.
</p>

<p>
Originally, in this part, I wanted to write a program that writes
dates to the filesystem. However, I ended up fighting with the type
checker so much that this post ended up mostly being about that.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Starting Out</h2>
<div class="outline-text-2" id="text-2">
<p>
The last time wasn't too bad. When I did some of this earlier, I
remember this being the hardest part.
</p>

<p>
Let's start by moving the existing <code>main.rs</code> out of the way so that we
can work with a fresh file.
</p>

<pre class="example">
$ pwd
/Users/joel/Projects/simple-log
$ cd src/
$ ls
main.rs
$ mv main.rs web_main.rs
$ touch main.rs
</pre>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Remembering "hello world"</h2>
<div class="outline-text-2" id="text-3">
<p>
Can I write a hello world without needing to look?
</p>

<p>
Let me try:
</p>

<pre class="example">
fn main() {
    println!("Hello, world");
}
</pre>

<p>
Then:
</p>

<pre class="example">
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
     Running `target/debug/simple-log`
Hello, world
</pre>

<p>
So, I guess I remember it OK. I was a little unsure about needing to
import something for <code>println!</code>, but it must be unnecessary.
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> A Naive Approach</h2>
<div class="outline-text-2" id="text-4">
<p>
Ok, moving on. Searching the Internet for "rust create a file" leads
me to this page on <code>std::fs::File</code>:
<a href="https://doc.rust-lang.org/std/fs/struct.File.html">https://doc.rust-lang.org/std/fs/struct.File.html</a>. Let's try a piece
from one example:
</p>

<pre class="example">
use std::fs::File;

fn main() {
    let mut f = try!(File::create("foo.txt"));
}
</pre>

<p>
Building:
</p>

<pre class="example">
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
&lt;std macros&gt;:5:8: 6:42 error: mismatched types:
 expected `()`,
    found `core::result::Result&lt;_, _&gt;`
(expected (),
    found enum `core::result::Result`) [E0308]
&lt;std macros&gt;:5 return $ crate:: result:: Result:: Err (
&lt;std macros&gt;:6 $ crate:: convert:: From:: from ( err ) ) } } )
&lt;std macros&gt;:1:1: 6:48 note: in expansion of try!
src/main.rs:5:17: 5:46 note: expansion site
error: aborting due to previous error
Could not compile `simple-log`.
</pre>

<p>
When I wrote the first version of this, this error took
a <i>really</i> longtime to figure out. I don't get on IRC very often
anymore, so figuring things out like this can be pretty
rough. Figuring it out left a big impression on me, so I know the
answer right away.
</p>

<p>
The problem with the above code is that <code>try!</code> expands to something
that returns early with an <code>Err</code> type in case of an error. Since
<code>main</code> returns Unit ("<code>()</code>")<sup><a id="fnr.1" name="fnr.1" class="footref" href="#fn.1">1</a></sup>, this causes a type error.
</p>

<p>
I think three things make this complicated:
</p>

<ol class="org-ol">
<li>At this point, I'm not really sure how to read the error
message. What does 'expected' and 'found' refer to? Since I know
the answer, I can see that 'expected' refers to the return value of
<code>main</code>, but I could easily see 'expected'/'found' going either
way.
</li>

<li>For me, reading <a href="https://doc.rust-lang.org/std/macro.try!.html">the documentation</a> for <code>try!</code> does not immediately
indicate to me how <code>try!</code> impacts the return value of the function it
is called from. Of course, I should have noticed the <code>return</code> in
the macro definition. At any rate, I didn't figure the problem out
until I found a remark in <a href="http://doc.rust-lang.org/stable/book/">the Rust book</a> about how <code>try!</code> can't be
called from <code>main</code> because of this exact problem.
</li>

<li>The error actually occurs inside a macro. It didn't hit me at the
time, but the rust compiler can output the code after macros have been
expanded. That makes this kind of thing much easier to debug.
</li>
</ol>

<p>
In number 3, expanding macros is alluded to. Viewing expanded macro is
such a useful way to debug these kinds of issues that its worth
discussing in more depth.
</p>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Debugging by Expanding Macros</h2>
<div class="outline-text-2" id="text-5">
<p>
First off, I figured this out by searching for "rust expand
macros". Given this code:
</p>

<pre class="example">
use std::fs::File;

fn main() {
    let mut f = try!(File::create("foo.txt"));
}
</pre>

<p>
&#x2026; we can run the compiler to show us the expanded macro output this way:
</p>

<pre class="example">
$ rustc src/main.rs --pretty=expanded -Z unstable-options
#![feature(no_std)]
#![no_std]
#[prelude_import]
use std::prelude::v1::*;
#[macro_use]
extern crate std as std;
use std::fs::File;

fn main() {
    let mut f =
        match File::create("foo.txt") {
            ::std::result::Result::Ok(val) =&gt; val,
            ::std::result::Result::Err(err) =&gt; {
                return ::std::result::Result::Err(::std::convert::From::from(err))
            }
        };
}
</pre>

<p>
This is <i>way</i> easier to debug. Macros are a very powerful tool, but
like any tool you need to know when and how to use them.
</p>

<p>
So, see that <code>return</code> statement in the above output? That's the
problem. Its trying to return an <code>Err</code> result from <code>main</code>, which again
has the return type Unit.
</p>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Fighting with Types</h2>
<div class="outline-text-2" id="text-6">
<p>
I need to know how to resolve this type problem. I'm going to start by imitating the
<code>try!</code> macro, but this time only returning Unit:
</p>

<pre class="example">
use std::fs::File;

fn main() {
    match File::create("foo.txt") {
        Ok(val) =&gt; val,
        Err(err) =&gt; ()
    }
}
</pre>

<p>
Running:
</p>

<pre class="example">
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
src/main.rs:5:5: 8:6 error: match arms have incompatible types:
 expected `std::fs::File`,
    found `()`
(expected struct `std::fs::File`,
    found ()) [E0308]
src/main.rs:5     match File::create("foo.txt") {
src/main.rs:6         Ok(val) =&gt; val,
src/main.rs:7         Err(err) =&gt; ()
src/main.rs:8     }
src/main.rs:7:21: 7:23 note: match arm with an incompatible type
src/main.rs:7         Err(err) =&gt; ()
                                  ^~
error: aborting due to previous error
Could not compile `simple-log`.
</pre>

<p>
Huh. So, I'm not really sure how to say "don't do anything, here". I
guess the type 'val' must be 'std::fs::File', and so its assuming that <i>any</i>
match return value must be that. Can I make the <code>Ok</code> branch not return
anything, either?
</p>

<pre class="example">
use std::fs::File;

fn main() {
    match File::create("foo.txt") {
        Ok(val) =&gt; (),
        Err(err) =&gt; ()
    }
}
</pre>

<p>
Running:
</p>

<pre class="example">
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
src/main.rs:6:12: 6:15 warning: unused variable: `val`, #[warn(unused_variables)] on by default
src/main.rs:6         Ok(val) =&gt; (),
                         ^~~
src/main.rs:7:13: 7:16 warning: unused variable: `err`, #[warn(unused_variables)] on by default
src/main.rs:7         Err(err) =&gt; ()
                          ^~~
     Running `target/debug/simple-log`
$ ls
Cargo.lock      Cargo.toml      foo.txt         src             target
</pre>

<p>
It created <code>foo.txt</code>! Of course, the code could be cleaner, but thats
fine for now. Let me try something else:
</p>

<pre class="example">
use std::fs::File;

fn main() {
    File::create("foo.txt")
}
</pre>

<p>
=&gt;
</p>

<pre class="example">
$ rm foo.txt
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
src/main.rs:5:5: 5:28 error: mismatched types:
 expected `()`,
    found `core::result::Result&lt;std::fs::File, std::io::error::Error&gt;`
(expected (),
    found enum `core::result::Result`) [E0308]
src/main.rs:5     File::create("foo.txt")
                  ^~~~~~~~~~~~~~~~~~~~~~~
error: aborting due to previous error
Could not compile `simple-log`.

To learn more, run the command again with --verbose.
</pre>

<p>
I've seen this before. This must mean <code>main</code> is returning the result of
<code>File::create</code>. I was thinking it would return nothing, but I guess I
didn't really think that through. What if I add a semicolon?
</p>

<pre class="example">
use std::fs::File;

fn main() {
    File::create("foo.txt");
}
</pre>

<p>
=&gt;
</p>

<pre class="example">
$ rm foo.txt
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
src/main.rs:5:5: 5:29 warning: unused result which must be used, #[warn(unused_must_use)] on by def
ault
src/main.rs:5     File::create("foo.txt");
                  ^~~~~~~~~~~~~~~~~~~~~~~~
     Running `target/debug/simple-log`
$ ls
Cargo.lock      Cargo.toml      foo.txt         src             target
</pre>

<p>
So, we now get an "unused result" warning, although it still runs and creates the
file. Let's go back and try doing something that handles the results:
</p>

<pre class="example">
use std::fs::File;

fn main() {
    match File::create("foo.txt") {
        Ok(val) =&gt; println!("File created!"),
        Err(err) =&gt; println!("Error: could not create file.")
    }
}
</pre>

<p>
=&gt;
</p>

<pre class="example">
$ rm foo.txt
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
src/main.rs:6:12: 6:15 warning: unused variable: `val`, #[warn(unused_variables)] on by default
src/main.rs:6         Ok(val) =&gt; println!("File created!"),
                         ^~~
src/main.rs:7:13: 7:16 warning: unused variable: `err`, #[warn(unused_variables)] on by default
src/main.rs:7         Err(err) =&gt; println!("Error: could not create file.")
                          ^~~
     Running `target/debug/simple-log`
File created!
</pre>

<p>
Now there are unused variables. My hunch is that either ellipses
or removing the variable name will fix this:
</p>

<pre class="example">
use std::fs::File;

fn main() {
    match File::create("foo.txt") {
        Ok(..) =&gt; println!("File created!"),
        Err(..) =&gt; println!("Error: could not create file.")
    }
}
</pre>

<p>
=&gt;
</p>

<pre class="example">
cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
     Running `target/debug/simple-log`
File created!
</pre>

<p>
So, ellipses worked. What happens when I instead remove the ellipses?
</p>


<pre class="example">
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
src/main.rs:6:12: 6:13 error: nullary enum variants are written with no trailing `( )`
src/main.rs:6         Ok() =&gt; println!("File created!"),
                         ^
src/main.rs:7:13: 7:14 error: nullary enum variants are written with no trailing `( )`
src/main.rs:7         Err() =&gt; println!("Error: could not create file.")
                          ^
error: aborting due to 2 previous errors
Could not compile `simple-log`.
</pre>

<p>
It didn't like that. I'm guessing that "nullary" means
"zero-arity", and it needs those removed. If I remove the parentheses totally:
</p>

<pre class="example">
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
src/main.rs:6:9: 6:11 error: this pattern has 0 fields, but the corresponding variant has 1 field [
E0023]
src/main.rs:6         Ok =&gt; println!("File created!"),
                      ^~
src/main.rs:7:9: 7:12 error: this pattern has 0 fields, but the corresponding variant has 1 field [
E0023]
src/main.rs:7         Err =&gt; println!("Error: could not create file.")
                      ^~~
error: aborting due to 2 previous errors
Could not compile `simple-log`.

To learn more, run the command again with --verbose.
</pre>

<p>
This makes sense, and is basically what I expected. My mental
model is starting to form!
</p>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> Writing to a file</h2>
<div class="outline-text-2" id="text-7">
<p>
Let's try something a little harder. How about this:
</p>

<ol class="org-ol">
<li>Try to create the log file. If it exists, great; if not, boo.
</li>

<li>Try to write a string to the log file.
</li>

<li>Clean everything up.
</li>
</ol>

<p>
This first example doesn't even attempt half of that, but we'll go
with it:
</p>

<pre class="example">
use std::fs::File;

fn log_something(filename, string) {
    let mut f = try!(File::create(filename));
    try!(f.write_all(string));
}

fn main() {
    match log_something("log.txt", "ITS ALIVE!!!") {
        Ok(..) =&gt; println!("File created!"),
        Err(..) =&gt; println!("Error: could not create file.")
    }
}
</pre>

<p>
=&gt;
</p>

<pre class="example">
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
src/main.rs:3:26: 3:27 error: expected one of `:` or `@`, found `,`
src/main.rs:3 fn log_something(filename, string) {
                                       ^
Could not compile `simple-log`.

To learn more, run the command again with --verbose.
$
</pre>

<p>
So I guess function arguments need must have type annotations:
</p>

<pre class="example">
use std::fs::File;

fn log_something(filename: &amp;'static str, string: &amp;'static str) {
    let mut f = try!(File::create(filename));
    try!(f.write_all(string));
}

fn main() {
    match log_something("log.txt", "ITS ALIVE!!!") {
        Ok(..) =&gt; println!("File created!"),
        Err(..) =&gt; println!("Error: could not create file.")
    }
}
</pre>

<p>
=&gt;
</p>

<pre class="example">
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
&lt;std macros&gt;:5:8: 6:42 error: mismatched types:
 expected `()`,
    found `core::result::Result&lt;_, _&gt;`
(expected (),
    found enum `core::result::Result`) [E0308]
&lt;std macros&gt;:5 return $ crate:: result:: Result:: Err (
&lt;std macros&gt;:6 $ crate:: convert:: From:: from ( err ) ) } } )
&lt;std macros&gt;:1:1: 6:48 note: in expansion of try!
src/main.rs:4:17: 4:45 note: expansion site
src/main.rs:5:12: 5:29 error: type `std::fs::File` does not implement any method in scope named `wr
ite_all`
src/main.rs:5     try!(f.write_all(string));
                         ^~~~~~~~~~~~~~~~~
&lt;std macros&gt;:1:1: 6:48 note: in expansion of try!
src/main.rs:5:5: 5:31 note: expansion site
src/main.rs:5:12: 5:29 help: methods from traits can only be called if the trait is in scope; the f
ollowing trait is implemented but not in scope, perhaps add a `use` for it:
src/main.rs:5:12: 5:29 help: candidate #1: use `std::io::Write`
&lt;std macros&gt;:5:8: 6:42 error: mismatched types:
 expected `()`,
    found `core::result::Result&lt;_, _&gt;`
(expected (),
    found enum `core::result::Result`) [E0308]
&lt;std macros&gt;:5 return $ crate:: result:: Result:: Err (
&lt;std macros&gt;:6 $ crate:: convert:: From:: from ( err ) ) } } )
&lt;std macros&gt;:1:1: 6:48 note: in expansion of try!
src/main.rs:5:5: 5:31 note: expansion site
src/main.rs:10:9: 10:15 error: mismatched types:
 expected `()`,
    found `core::result::Result&lt;_, _&gt;`
(expected (),
    found enum `core::result::Result`) [E0308]
src/main.rs:10         Ok(..) =&gt; println!("File created!"),
                       ^~~~~~
src/main.rs:11:9: 11:16 error: mismatched types:
 expected `()`,
    found `core::result::Result&lt;_, _&gt;`
(expected (),
    found enum `core::result::Result`) [E0308]
src/main.rs:11         Err(..) =&gt; println!("Error: could not create file.")
                       ^~~~~~~
error: aborting due to 5 previous errors
Could not compile `simple-log`.

To learn more, run the command again with --verbose.
</pre>

<p>
That's a lot of errors. Looking at the first error, I'm guessing
that <code>log_something</code> needs to have a return value specified. I've
tried a few things, but right now I'm stuck. To the search engines!
</p>

<p>
A few minutes have passed, and I finally have <i>an</i> answer. I did
<a href="https://github.com/search?p=15&q=Result+language:rust&ref=simplesearch&type=Code&utf8=%E2%9C%93">some searching on GitHub</a>,
but it wasn't fruitful. I tried about 50 different things, but got
this to work:
</p>

<pre class="example">
use std::io::prelude::*;
use std::fs::File;

fn log_something(filename: &amp;'static str, string: &amp;'static str) -&gt; Result&lt;File,std::io::error::Error&gt; {
    let mut f = try!(File::create(filename));
    try!(f.write_all(string));
}

fn main() {
    match log_something("log.txt", "ITS ALIVE!!!") {
        Ok(..) =&gt; println!("File created!"),
        Err(..) =&gt; println!("Error: could not create file.")
    }
}
</pre>

<p>
I'm not really sure <i>why</i> it works. If I understand correctly, the
return value is of <code>Result</code> type that's parameterized with the types
<code>File</code> and <code>std::io::error::Error</code>. What does this mean, exactly? It
seems strange to me that of the two types, one type is the
actual result (a file), yet the second is an <code>Error</code> type. Why? I'm
thinking that once I fix the remaining error(s), this will need fixing
again.
</p>

<p>
So, now when I try to run it, I get:
</p>

<pre class="example">
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
src/main.rs:8:22: 8:28 error: mismatched types:
 expected `&amp;[u8]`,
    found `&amp;'static str`
(expected slice,
    found str) [E0308]
src/main.rs:8     try!(f.write_all(string));
                                   ^~~~~~
&lt;std macros&gt;:1:1: 6:48 note: in expansion of try!
src/main.rs:8:5: 8:31 note: expansion site
error: aborting due to previous error
Could not compile `simple-log`.

To learn more, run the command again with --verbose.
</pre>

<p>
Ok, so I saw in the example that they prefixed the string with a <code>b</code>,
which I neglected to do just to see what would happen. Fixing the
parameters:
</p>


<pre class="example">
use std::io::prelude::*;
use std::fs::File;

fn log_something(filename: &amp;'static str, string: &amp;'static [u8; 12]) -&gt; Result&lt;File,std::io::error::Error&gt; {
    let mut f = try!(File::create(filename));
    try!(f.write_all(string));
}

fn main() {
    match log_something("log.txt", "ITS ALIVE!!!") {
        Ok(..) =&gt; println!("File created!"),
        Err(..) =&gt; println!("Error: could not create file.")
    }
}
</pre>

<p>
=&gt;
</p>

<pre class="example">
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
src/main.rs:4:85: 4:106 error: struct `Error` is private
src/main.rs:4 fn log_something(filename: &amp;'static str, string: &amp;'static [u8; 12]) -&gt; Result&lt;File, std::io::error::Error&gt; {
                                                                                                  ^~~~~~~~~~~~~~~~~~~~~
error: aborting due to previous error
Could not compile `simple-log`.
</pre>

<p>
Ugh &#x2013; I knew this was going to be a problem. Time to do some
searching and reading.
</p>

<p>
The Rust book has <a href="https://doc.rust-lang.org/book/error-handling.html">a section</a> on <code>Result</code>. Hmm. It seems like what I'm
doing may not be idiomatic? I'd say that it seems like the "best" way
to handle what is going on, but I <i>am</i> confused. I've seen this
<code>unwrap</code> thing a few times, and it seems like it could be what I
want. If I try unwrap, things might be different:
</p>

<pre class="example">
fn log_something(filename: &amp;'static str, string: &amp;'static [u8; 12]) {
    let mut f = File::create(filename).unwrap();
    f.write_all(string);
}

fn main() {
    log_something("log.txt", b"ITS ALIVE!!!")
}
</pre>
<p>
=&gt;
</p>
<pre class="example">
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
src/main.rs:6:5: 6:25 warning: unused result which must be used, #[warn(unused_must_use)] on by def
ault
src/main.rs:6     f.write_all(string);
                  ^~~~~~~~~~~~~~~~~~~~
     Running `target/debug/simple-log`
$ ls
Cargo.lock      Cargo.toml      foo.txt         log.txt         src             target
$ cat log.txt
ITS ALIVE!!!
</pre>

<p>
So, that worked, although there is a warning. I think this is not "the
Rust way", since its failing early/throwing errors away.
</p>

<p>
The real problem with <code>try!</code> and returning a <code>Result</code> is that there's
this weirdness dealing with this line in the <code>try!</code> macro:
</p>
<pre class="example">
return $crate::result::Result::Err($crate::convert::From::from(err))
</pre>
<p>
This means that whatever I pass in has to have a <code>From::from</code> trait
implemented on an enum, but I really have no idea how traits or enums
work, and I think the whole thing is overkill anyway for what I'm
trying to do.
</p>

<p>
I've gone to the documentation for <code>Result</code>, and it looks like I may
be going in the wrong direction:
<a href="https://doc.rust-lang.org/std/result/">https://doc.rust-lang.org/std/result/</a>. This <code>io::Result</code> example seems
to be similar enough to what I'm doing, so let me see if I can fix
that up:
</p>

<pre class="example">
use std::io::prelude::*;
use std::fs::File;
use std::io;

fn log_something(filename: &amp;'static str, string: &amp;'static [u8; 12]) -&gt; io::Result&lt;()&gt; {
    let mut f = try!(File::create(filename));
    try!(f.write_all(string));
}

fn main() {
    match log_something("log.txt", b"ITS ALIVE!!!") {
        Ok(..) =&gt; println!("File created!"),
        Err(..) =&gt; println!("Error: could not create file.")
    }
}
</pre>
<p>
=&gt;
</p>
<pre class="example">
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
src/main.rs:5:1: 8:2 error: not all control paths return a value [E0269]
src/main.rs:5 fn log_something(filename: &amp;'static str, string: &amp;'static [u8; 12]) -&gt; io::Result&lt;()&gt;
 {
src/main.rs:6     let mut f = try!(File::create(filename));
src/main.rs:7     try!(f.write_all(string));
src/main.rs:8 }
error: aborting due to previous error
Could not compile `simple-log`.

To learn more, run the command again with --verbose.
</pre>


<p>
After some time thinking, I see the problem:
an <code>Ok(())</code> statement must be added as the final statement in
<code>log_something</code>. I realized this because I saw that this is how things
happen in the <code>Result</code> documentation.
</p>

<p>
I've been used to the idea that not having something after the final
semicolon means <code>return ()</code>; however, the message "not all control
paths return a value" doesn't make sense &#x2013; to me, this is a type
mismatch. Unless, of course, <code>()</code> is not a value, which it might not
be, but I still think that's confusing.
</p>

<p>
Our final result (for this post):
</p>

<pre class="example">
use std::io::prelude::*;
use std::fs::File;
use std::io;

fn log_something(filename: &amp;'static str, string: &amp;'static [u8; 12]) -&gt; io::Result&lt;()&gt; {
    let mut f = try!(File::create(filename));
    try!(f.write_all(string));
    Ok(())
}

fn main() {
    match log_something("log.txt", b"ITS ALIVE!!!") {
        Ok(..) =&gt; println!("File created!"),
        Err(..) =&gt; println!("Error: could not create file.")
    }
}
</pre>
<p>
=&gt;
</p>
<pre class="example">
$ rm log.txt
$ cargo run
     Running `target/debug/simple-log`
File created!
$ cat log.txt
ITS ALIVE!!!
</pre>

<p>
Ok, it works. Great. I'm going to end here because this has been pretty
challenging. I'm sure improvements could be made on this code, but
this is a good stopping point and a good time to research dates and
times in Rust, which will be the <a href="http://joelmccracken.github.io/entries/a-simple-web-app-in-rust-pt-2b/">the next post</a>.
</p>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> Updates</h2>
<div class="outline-text-2" id="text-8">
<ol class="org-ol">
<li>NMSpaz pointed out
<a href="https://www.reddit.com/r/rust/comments/38ahgr/a_simple_web_app_in_rust_part_2a/crvvhkf">on Reddit</a>
that one of my examples had an error in it.
</li>
</ol>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" name="fn.1" class="footnum" href="#fnr.1">1</a></sup> <p class="footpara">
lol.
</p></div>


</div>
</div>
  </article>

  <div id="disqus_thread" style="margin: 3em;"></div>
  <script type="text/javascript">
   /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
   var disqus_shortname = 'joelmccracken'; // required: replace example with your forum shortname

   /* * * DON'T EDIT BELOW THIS LINE * * */
   (function() {
     var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
     dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
     (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
   })();
  </script>
</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

    <h2 class="footer-heading">Joel McCracken</h2>

    <div class="footer-col-1 column">
      <ul>
        <li><a href="mailto:mccracken.joel@gmail.com">mccracken.joel@gmail.com</a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/JoelMcCracken">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username">JoelMcCracken</span>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/JoelMcCracken">
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>
            <span class="username">JoelMcCracken</span>
          </a>
        </li>
      </ul>
    </div>

    <!-- 
    <div class="footer-col-3 column">
      <p class="text">would like to add some rotating content down here</p>
    </div>
    -->
  </div>

</footer>


    <script type="text/javascript">
 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-7759066-1']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
 })();
</script>

    </body>
</html>
