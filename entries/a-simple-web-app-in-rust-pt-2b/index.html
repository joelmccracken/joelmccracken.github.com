<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>A Simple Web App in Rust, Part 2b</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="Nebby about Tech">
    <link rel="canonical" href="http://joelmccracken.github.io/entries/a-simple-web-app-in-rust-pt-2b/">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">
</head>


    <body>

        <header class="site-header">
  <div class="wrap">
    <a class="site-title" href="/">Joel's Journal</a>
  </div>
</header>


        <div class="page-content">
            <div class="wrap">
                <div class="post">
                    <header class="post-header">
                        <h1>A Simple Web App in Rust, Part 2b</h1>
                        <p class="meta">Jun 7, 2015</p>
                    </header>

                    <article class="post-content">
                        <div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. The Series</a></li>
<li><a href="#sec-2">2. Using Chrono</a></li>
<li><a href="#sec-3">3. Writing the Date/Time to a File</a></li>
<li><a href="#sec-4">4. Building a File Logger</a>
<ul>
<li><a href="#sec-4-1">4.1. Misunderstanding <code>u8</code></a></li>
<li><a href="#sec-4-2">4.2. Filling in Missing Pieces</a></li>
</ul>
</li>
<li><a href="#sec-5">5. Conclusion &amp; Next Steps</a></li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> The Series</h2>
<div class="outline-text-2" id="text-1">
<p>
This is a post in a series of me writing down my experience as I try to
build a simple web app in Rust.
</p>

<p>
So far, we have:
</p>

<ol class="org-ol">
<li><a href="http://joelmccracken.github.io/entries/a-simple-web-app-in-rust-pt-1/">Defined the goal &amp; Written a "Hello World" web server</a>
</li>
<li><a href="http://joelmccracken.github.io/entries/a-simple-web-app-in-rust-pt-2a/">Figured out how to write to a file</a>
</li>
</ol>

<p>
The last part was especially harrowing. This piece will be to
investigate date/time formatting in Rust, with a focus on writing
visiting time in a nice format.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Using Chrono</h2>
<div class="outline-text-2" id="text-2">
<p>
So, searching for "date" on crates.io shows
<a href="https://crates.io/search?q=date">one prominent result</a>,
namely the crate "chrono". This looks very popular, and was updated
very recently, so it looks like a good candidate. A look through the
README seems to show that it has decent date/time pretty printing functionality.
</p>

<p>
The first thing would be to add the Chrono requirement line to
<code>Cargo.toml</code>, but first let's move the old <code>main.rs</code> out of the way so
that there is a new place to experiment:
</p>


<pre class="example">
$ ls
Cargo.lock Cargo.toml log.txt    src        target
$ cd src/
$ ls
main.rs     web_main.rs
$ git mv main.rs main_file_writing.rs
$ touch main.rs
$ git add main.rs
$ git status
On branch master
Your branch is up-to-date with 'origin/master'.
Changes to be committed:
  (use "git reset HEAD &lt;file&gt;..." to unstage)

        modified:   main.rs
        copied:     main.rs -&gt; main_file_writing.rs

Untracked files:
  (use "git add &lt;file&gt;..." to include in what will be committed)

        ../log.txt

$ git commit -m 'move file writing out of the way for working with dates'
[master 4cd2b0e] move file writing out of the way for working with dates
 2 files changed, 16 deletions(-)
 rewrite src/main.rs (100%)
 copy src/{main.rs =&gt; main_file_writing.rs} (100%)
</pre>

<p>
Adding the dependency on Chrono to <code>Cargo.toml</code>:
</p>

<pre class="example">
[package]
name = "simple-log"
version = "0.1.0"
authors = ["Joel McCracken &lt;mccracken.joel@gmail.com&gt;"]

[dependencies]

chrono = "0.2"

[dependencies.nickel]

git = "https://github.com/nickel-org/nickel.rs.git"
</pre>


<p>
The readme says this next:
</p>

<pre class="example">
And put this in your crate root:

    extern crate chrono;
</pre>

<p>
I don't know what this means, but I'm just going to try to put it on
top of <code>main.rs</code> because it looks like Rust code:
</p>

<pre class="example">
extern crate chrono;

fn main() { }
</pre>

<p>
compiling:
</p>

<pre class="example">
$ cargo run
    Updating registry `https://github.com/rust-lang/crates.io-index`
 Downloading num v0.1.25
 Downloading rand v0.3.8
 Downloading chrono v0.2.14
   Compiling rand v0.3.8
   Compiling num v0.1.25
   Compiling chrono v0.2.14
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
     Running `/Users/joel/Projects/simple-log/target/debug/simple-log`
</pre>

<p>
So, it looks like it downloaded Chrono, compiled successfully, and
exited. Rad. I think the next step would be to try to use it. Based
upon the first example listed, I have this:
</p>

<pre class="example">
extern crate chrono;
use chrono::*;

fn main() {
    let local: DateTime&lt;Local&gt; = Local::now();
    println!('{}', local);
}
</pre>

<p>
=&gt;
</p>

<pre class="example">
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
main.rs:6:14: 6:16 error: unterminated character constant: '{
main.rs:6     println!('{}', local);
                       ^~
Could not compile `simple-log`.

To learn more, run the command again with --verbose.
</pre>

<p>
&#x2026;? After I look at this for a second, I think its telling me that I
need to use double quotes, not single quotes. which makes some sense,
since single quotes are used in lifetime specifications.
</p>

<p>
After switching from single to double quotes:
</p>

<pre class="example">
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
     Running `/Users/joel/Projects/simple-log/target/debug/simple-log`
2015-06-05 16:54:47.483088 -04:00
</pre>

<p>
&#x2026; <i>whoa</i>. That was easy. It looks like <code>println!</code> has some kind of
interface for whatever is being printed and can print many different
things.
</p>

<p>
There is some irony here. So far, I was able to generate a simple
hello world web application and print a well-formatted date and time
with really very little effort, but writing to a file cost me dearly
in time. I'm not sure what the lesson is, here. I think it is clear
that the rust community has gone through great effort to make their
packages nice to work with, even if the language is still hard to use
(for me).
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Writing the Date/Time to a File</h2>
<div class="outline-text-2" id="text-3">
<p>
I think the next sensible task would be to actually write this string
to a file, and for this, I want to look at what I ended up with in the
last entry:
</p>

<pre class="example">
$ cat main_file_writing.rs
use std::io::prelude::*;
use std::fs::File;
use std::io;

fn log_something(filename: &amp;'static str, string: &amp;'static [u8; 12]) -&gt; io::Result&lt;()&gt; {
    let mut f = try!(File::create(filename));
    try!(f.write_all(string));
    Ok(())
}

fn main() {
    match log_something("log.txt", b"ITS ALIVE!!!") {
        Ok(..) =&gt; println!("File created!"),
        Err(..) =&gt; println!("Error: could not create file.")
    }
}
</pre>

<p>
I'll just do a real quick merge of the above example with this one:
</p>

<pre class="example">
extern crate chrono;

use std::io::prelude::*;
use std::fs::File;
use std::io;
use chrono::*;

fn log_something(filename: &amp;'static str, string: &amp;'static [u8; 12]) -&gt; io::Result&lt;()&gt; {
    let mut f = try!(File::create(filename));
    try!(f.write_all(string));
    Ok(())
}

fn main() {
    let local: DateTime&lt;Local&gt; = Local::now();
    println!('{}', local);
    match log_something("log.txt", b"ITS ALIVE!!!") {
        Ok(..) =&gt; println!("File created!"),
        Err(..) =&gt; println!("Error: could not create file.")
    }
}
</pre>

<p>
compiling:
</p>

<pre class="example">
$ ls
Cargo.lock      Cargo.toml      log.txt         src             target
$ pwd
/Users/joel/Projects/simple-log
$ ls
Cargo.lock      Cargo.toml      log.txt         src             target
$ rm log.txt
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
     Running `target/debug/simple-log`
2015-06-05 17:08:57.814176 -04:00
File created!
$ cat log.txt
ITS ALIVE!!!$
</pre>

<p>
That all worked! It feels really good to go from struggling with a
language, to being able to put things together with much less
frustration.
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Building a File Logger</h2>
<div class="outline-text-2" id="text-4">
<p>
We're getting closer to writing a real, bona fide piece of the final
system. It hits me that I might like to write some tests for this
code, but I'll add those in later.
</p>


<p>
Here's what this function should do:
</p>

<ol class="org-ol">
<li>Given a file name,
</li>
<li>Create it first if doesn't exist, and open the file.
</li>
<li>Create a time/date string,
</li>
<li>Write that string to the file, and close the file.
</li>
</ol>
</div>


<div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> Misunderstanding <code>u8</code></h3>
<div class="outline-text-3" id="text-4-1">
<p>
My first attempt:
</p>

<pre class="example">
extern crate chrono;

use std::io::prelude::*;
use std::fs::File;
use std::io;
use chrono::*;

fn log_time(filename: &amp;'static str) -&gt; io::Result&lt;()&gt; {

    let local: DateTime&lt;Local&gt; = Local::now();
    let time_str = local.format("%Y").to_string();
    let mut f = try!(File::create(filename));
    try!(f.write_all(time_str));
    Ok(())
}

fn main() {
    match log_time("log.txt") {
        Ok(..) =&gt; println!("File created!"),
        Err(..) =&gt; println!("Error: could not create file.")
    }
}
</pre>

<p>
=&gt;
</p>

<pre class="example">
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
src/main.rs:13:22: 13:30 error: mismatched types:
 expected `&amp;[u8]`,
    found `collections::string::String`
(expected &amp;-ptr,
    found struct `collections::string::String`) [E0308]
src/main.rs:13     try!(f.write_all(time_str));
                                    ^~~~~~~~
&lt;std macros&gt;:1:1: 6:48 note: in expansion of try!
src/main.rs:13:5: 13:33 note: expansion site
error: aborting due to previous error
Could not compile `simple-log`.

To learn more, run the command again with --verbose.
</pre>

<p>
Ugh. So, I know that there are many types of strings in
Rust<sup><a id="fnr.1" name="fnr.1" class="footref" href="#fn.1">1</a></sup>, and it
looks like I need a different one, here. Thing is, I don't know how to
do this, so I'll have to do some searching.
</p>

<p>
I remember seeing <a href="http://doc.rust-lang.org/book/strings.html">a section in the Rust</a> book specifically about
strings. Looking into it, it says that a can be converted from
<code>String</code> to <code>&amp;str</code> with an ampersand (<code>&amp;</code>). I don't think this is
quite right, because it looks like it's expecting a <code>[u8]</code> and <i>not</i>
a <code>&amp;str</code> <sup><a id="fnr.2" name="fnr.2" class="footref" href="#fn.2">2</a></sup> Lemmie try that:
</p>

<pre class="example">
extern crate chrono;

use std::io::prelude::*;
use std::fs::File;
use std::io;
use chrono::*;

fn log_time(filename: &amp;'static str) -&gt; io::Result&lt;()&gt; {

    let local: DateTime&lt;Local&gt; = Local::now();
    let time_str = local.format("%Y").to_string();
    let mut f = try!(File::create(filename));
    try!(f.write_all(&amp;time_str));
    Ok(())
}

fn main() {
    match log_time("log.txt") {
        Ok(..) =&gt; println!("File created!"),
        Err(..) =&gt; println!("Error: could not create file.")
    }
}
</pre>

<p>
=&gt;
</p>
<pre class="example">
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
src/main.rs:13:22: 13:31 error: mismatched types:
 expected `&amp;[u8]`,
    found `&amp;collections::string::String`
(expected slice,
    found struct `collections::string::String`) [E0308]
src/main.rs:13     try!(f.write_all(&amp;time_str));
                                    ^~~~~~~~~
&lt;std macros&gt;:1:1: 6:48 note: in expansion of try!
src/main.rs:13:5: 13:34 note: expansion site
error: aborting due to previous error
Could not compile `simple-log`.

To learn more, run the command again with --verbose.
</pre>


<p>
Well. Apparently, adding the ampersand just converted a <code>String</code> to an
<code>&amp;String</code>. That seems to directly contradict what the Rust book is
saying, but I also probably don't know what is going on.
</p>

<p>
&#x2026;And I just reached the end of the chapter on strings. Harumph. As
far as I can tell, there isn't anything in here.
</p>

<p>
I walked away from this for a while (because, you know, life), and
while I was gone it hit me. All this time, I have been reading <code>u8</code> as
a short form of <code>UTF-8</code>, but now that I think about it, it almost
certainly actually means "unsigned 8-bit integer". And, I remember
seeing an <code>as_bytes</code> method, so let me try that instead:
</p>

<pre class="example">
extern crate chrono;

use std::io::prelude::*;
use std::fs::File;
use std::io;
use chrono::*;

fn log_time(filename: &amp;'static str) -&gt; io::Result&lt;()&gt; {
    let local: DateTime&lt;Local&gt; = Local::now();
    let bytes = local.format("%Y").to_string().as_bytes();
    let mut f = try!(File::create(filename));
    try!(f.write_all(bytes));
    Ok(())
}

fn main() {
    match log_time("log.txt") {
        Ok(..) =&gt; println!("File created!"),
        Err(..) =&gt; println!("Error: could not create file.")
    }
}
</pre>

<p>
=&gt;
</p>

<pre class="example">
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
main.rs:10:17: 10:47 error: borrowed value does not live long enough
main.rs:10     let bytes = local.format("%Y").to_string().as_bytes();
                           ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
main.rs:10:59: 14:2 note: reference must be valid for the block suffix following statement 1 at 10:
58...
main.rs:10     let bytes = local.format("%Y").to_string().as_bytes();
main.rs:11     let mut f = try!(File::create(filename));
main.rs:12     try!(f.write_all(bytes));
main.rs:13     Ok(())
main.rs:14 }
main.rs:10:5: 10:59 note: ...but borrowed value is only valid for the statement at 10:4
main.rs:10     let bytes = local.format("%Y").to_string().as_bytes();
               ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
main.rs:10:5: 10:59 help: consider using a `let` binding to increase its lifetime
main.rs:10     let bytes = local.format("%Y").to_string().as_bytes();
               ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
error: aborting due to previous error
Could not compile `simple-log`.

To learn more, run the command again with --verbose.
</pre>

<p>
Well, I <i>hope</i> this is progress. Does this error mean I fixed
something, and there was something else wrong that was obscuring this
problem? Did I introduce a whole new problem?
</p>

<p>
The strange thing about this error message is that it seems to be
talking about error messages on the same line. I don't really
understand most of it, but I'm thinking it is saying that I need to
add a let in the middle of the sequence of method calls. Lets try:
</p>

<pre class="example">
fn log_time(filename: &amp;'static str) -&gt; io::Result&lt;()&gt; {
    let local: DateTime&lt;Local&gt; = Local::now();
    let formatted = local.format("%Y").to_string();
    let bytes = formatted.as_bytes();
    let mut f = try!(File::create(filename));
    try!(f.write_all(bytes));
    Ok(())
}
</pre>

<p>
=&gt;
</p>

<pre class="example">
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
     Running `target/debug/simple-log`
File created!
$ cat log.txt
2015$
</pre>

<p>
Great! All the pieces are here. Before I move on, I want to reflect
that I find this a little disappointing. It seems like Rust should be
able to infer the correct behavior in the previous snippet without my
guidance.
</p>

<p>
Testing the script:
</p>

<pre class="example">
$ ls
Cargo.lock      Cargo.toml      log.txt         src             target
$ rm log.txt
$ cargo run
     Running `target/debug/simple-log`
File created!
$ cat log.txt
2015$ cargo run
     Running `target/debug/simple-log`
File created!
$ cat log.txt
2015$
</pre>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> Filling in Missing Pieces</h3>
<div class="outline-text-3" id="text-4-2">
<p>
A few problems:
</p>

<ol class="org-ol">
<li>No newline. This is really gross.
</li>

<li>The format needs some work.
</li>

<li>It appears that the old value is being erased by the new value.
</li>
</ol>

<p>
Let's verify #3 by fixing the format. If the time changes between
runs, then we will know that's what is happening.
</p>

<p>
The <code>format</code> method of <code>DateTime</code> uses the standard strftime
formatting conventions. Ideally, I would like times to be something
like:
</p>
<pre class="example">
Sat, Jun 6 2015 05:32:00 PM
Sun, Jun 7 2015 08:35:00 AM
</pre>
<p>
&#x2026;etc. This should be readable enough for me to use. After reading
<a href="https://lifthrasiir.github.io/rust-chrono/chrono/format/strftime/index.html">the documentation</a> for a while, I've come up with this:
</p>

<pre class="example">
extern crate chrono;

use std::io::prelude::*;
use std::fs::File;
use std::io;
use chrono::*;

fn log_time(filename: &amp;'static str) -&gt; io::Result&lt;()&gt; {
    let local: DateTime&lt;Local&gt; = Local::now();
    let formatted = local.format("%a, %b %d %Y %I:%M:%S %p\n").to_string();
    let bytes = formatted.as_bytes();
    let mut f = try!(File::create(filename));
    try!(f.write_all(bytes));
    Ok(())
}

fn main() {
    match log_time("log.txt") {
        Ok(..) =&gt; println!("File created!"),
        Err(..) =&gt; println!("Error: could not create file.")
    }
}
</pre>

<p>
Testing it:
</p>

<pre class="example">
$ rm log.txt
$ cargo run
     Running `target/debug/simple-log`
File created!
$ cat log.txt
Sun, Jun 07 2015 06:37:21 PM
$ sleep 5; cargo run
     Running `target/debug/simple-log`
File created!
$ cat log.txt
Sun, Jun 07 2015 06:37:41 PM
</pre>

<p>
So, clearly the program is overwriting the log entries, which tbqh is
what I expect, as I remember the documentation for <code>File::create</code>
specifying that this is what would happen. So, I need to look at the
documentation for manipulating files again.
</p>

<p>
I did some searching around, and basically finding the answer to this
isn't trivial. After a while I found the documentation for
<a href="https://doc.rust-lang.org/std/path/struct.Path.html">std::path::Path</a>, which has an <code>exists</code> method.
</p>

<p>
At this point, the interactions between types in my application is
becoming increasingly hard to manage. I feel nervous, so I will commit
before continuing.
</p>

<p>
I want to pull the time entry string generation out of the <code>log_time</code>
function because it seems like the entry formatting/creation is
distinct from the file manipulation code. So, trying this:
</p>

<pre class="example">
extern crate chrono;

use std::io::prelude::*;
use std::fs::File;
use std::io;
use chrono::*;


fn log_time_entry() -&gt; String {
    let local: DateTime&lt;Local&gt; = Local::now();
    let formatted = local.format("%a, %b %d %Y %I:%M:%S %p\n").to_string();
    formatted
}

fn log_time(filename: &amp;'static str) -&gt; io::Result&lt;()&gt; {
    let bytes = log_time_entry().as_bytes();
    let mut f = try!(File::create(filename));
    try!(f.write_all(bytes));
    Ok(())
}

fn main() {
    match log_time("log.txt") {
        Ok(..) =&gt; println!("File created!"),
        Err(..) =&gt; println!("Error: could not create file.")
    }
}
</pre>

<p>
=&gt;
</p>

<pre class="example">
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
src/main.rs:16:17: 16:33 error: borrowed value does not live long enough
src/main.rs:16     let bytes = log_time_entry().as_bytes();
                               ^~~~~~~~~~~~~~~~
src/main.rs:16:45: 20:2 note: reference must be valid for the block suffix following statement 0 at
 16:44...
src/main.rs:16     let bytes = log_time_entry().as_bytes();
src/main.rs:17     let mut f = try!(File::create(filename));
src/main.rs:18     try!(f.write_all(bytes));
src/main.rs:19     Ok(())
src/main.rs:20 }
src/main.rs:16:5: 16:45 note: ...but borrowed value is only valid for the statement at 16:4
src/main.rs:16     let bytes = log_time_entry().as_bytes();
                   ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
src/main.rs:16:5: 16:45 help: consider using a `let` binding to increase its lifetime
src/main.rs:16     let bytes = log_time_entry().as_bytes();
                   ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
error: aborting due to previous error
Could not compile `simple-log`.

To learn more, run the command again with --verbose.
</pre>

<p>
So, this looks just like the problem I had earlier. Does
borrowing/ownership require that a function have an explicit reference
to resources? That seems a little strange. I will try to fix it again:
</p>

<pre class="example">
extern crate chrono;

use std::io::prelude::*;
use std::fs::File;
use std::io;
use chrono::*;

fn formatted_time_entry() -&gt; String {
    let local: DateTime&lt;Local&gt; = Local::now();
    let formatted = local.format("%a, %b %d %Y %I:%M:%S %p\n").to_string();
    formatted
}

fn log_time(filename: &amp;'static str) -&gt; io::Result&lt;()&gt; {
    let entry = formatted_time_entry();
    let bytes = entry.as_bytes();

    let mut f = try!(File::create(filename));
    try!(f.write_all(bytes));
    Ok(())
}

fn main() {
    match log_time("log.txt") {
        Ok(..) =&gt; println!("File created!"),
        Err(..) =&gt; println!("Error: could not create file.")
    }
}
</pre>

<p>
=&gt;
</p>

<pre class="example">
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
     Running `target/debug/simple-log`
File created!
</pre>

<p>
So, adding an explicit reference seems to be the
solution. Whatever. It is an easy rule to learn and follow.
</p>

<p>
Next I want to extract the file manipulation code to its own function:
</p>

<pre class="example">
extern crate chrono;

use std::io::prelude::*;
use std::fs::File;
use std::io;
use chrono::*;

fn formatted_time_entry() -&gt; String {
    let local: DateTime&lt;Local&gt; = Local::now();
    let formatted = local.format("%a, %b %d %Y %I:%M:%S %p\n").to_string();
    formatted
}

fn record_entry_in_log(filename: &amp;str, bytes: &amp;[u8]) -&gt; io::Result&lt;()&gt; {
    let mut f = try!(File::create(filename));
    try!(f.write_all(bytes));
    Ok(())
}

fn log_time(filename: &amp;'static str) -&gt; io::Result&lt;()&gt; {
    let entry = formatted_time_entry();
    let bytes = entry.as_bytes();

    try!(record_entry_in_log(filename, &amp;bytes));
    Ok(())
}

fn main() {
    match log_time("log.txt") {
        Ok(..) =&gt; println!("File created!"),
        Err(..) =&gt; println!("Error: could not create file.")
    }
}
</pre>

<p>
And this works. I made some initial errors, but they were quickly
corrected and was all stuff that has been covered here before.
</p>

<p>
Looking into the documentation for
<a href="https://doc.rust-lang.org/std/fs/struct.File.html">std::fs::File</a>, I notice a reference to
<a href="https://doc.rust-lang.org/std/fs/struct.OpenOptions.html">std::fs::OpenOptions</a>, which is <i>exactly</i> what I have been looking
for. It would definitely be better than using <code>std::path</code>.
</p>


<p>
My first attempt:
</p>

<pre class="example">
extern crate chrono;

use std::io::prelude::*;
use std::fs::{File,OpenOptions};
use std::io;
use chrono::{DateTime,Local};


fn formatted_time_entry() -&gt; String {
    let local: DateTime&lt;Local&gt; = Local::now();
    let formatted = local.format("%a, %b %d %Y %I:%M:%S %p\n").to_string();
    formatted
}

fn record_entry_in_log(filename: &amp;str, bytes: &amp;[u8]) -&gt; io::Result&lt;()&gt; {
    let mut file = try!(OpenOptions::new().
                        append(true).
                        create(true).
                        open(filename));
    try!(file.write_all(bytes));
    Ok(())
}

fn log_time(filename: &amp;'static str) -&gt; io::Result&lt;()&gt; {
    let entry = formatted_time_entry();
    let bytes = entry.as_bytes();

    try!(record_entry_in_log(filename, &amp;bytes));
    Ok(())
}

fn main() {
    match log_time("log.txt") {
        Ok(..) =&gt; println!("File created!"),
        Err(..) =&gt; println!("Error: could not create file.")
    }
}
</pre>

<p>
=&gt;
</p>

<pre class="example">
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
src/main.rs:4:15: 4:19 warning: unused import, #[warn(unused_imports)] on by default
src/main.rs:4 use std::fs::{File,OpenOptions};
                            ^~~~
     Running `target/debug/simple-log`
Error: could not create file.
</pre>

<p>
Interesting. I see that it <i>is</i> actually creating the file, after
which I notice this is the message I've hard-coded into <code>main</code>. Ugh; I
think this will work:
</p>

<pre class="example">
extern crate chrono;

use std::io::prelude::*;
use std::fs::{File,OpenOptions};
use std::io;
use chrono::{DateTime,Local};


fn formatted_time_entry() -&gt; String {
    let local: DateTime&lt;Local&gt; = Local::now();
    let formatted = local.format("%a, %b %d %Y %I:%M:%S %p\n").to_string();
    formatted
}

fn record_entry_in_log(filename: &amp;str, bytes: &amp;[u8]) -&gt; io::Result&lt;()&gt; {
    let mut file = try!(OpenOptions::new().
                        append(true).
                        create(true).
                        open(filename));
    try!(file.write_all(bytes));
    Ok(())
}

fn log_time(filename: &amp;'static str) -&gt; io::Result&lt;()&gt; {
    let entry = formatted_time_entry();
    let bytes = entry.as_bytes();

    try!(record_entry_in_log(filename, &amp;bytes));
    Ok(())
}

fn main() {
    match log_time("log.txt") {
        Ok(..) =&gt; println!("File created!"),
        Err(e) =&gt; println!("Error: {}", e)
    }
}
</pre>

<p>
=&gt;
</p>

<pre class="example">
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
src/main.rs:4:15: 4:19 warning: unused import, #[warn(unused_imports)] on by default
src/main.rs:4 use std::fs::{File,OpenOptions};
                            ^~~~
     Running `target/debug/simple-log`
Error: Bad file descriptor (os error 9)
</pre>

<p>
Weird. Searching for this "bad file descriptor" error message seems to
indicate that this happens when a file descriptor is used has been
closed. what happens if I comment out the <code>file.write_all</code> call?
</p>

<pre class="example">
$ rm log.txt
$ cargo run
   Compiling simple-log v0.1.0 (file:///Users/joel/Projects/simple-log)
src/main.rs:3:5: 3:25 warning: unused import, #[warn(unused_imports)] on by default
src/main.rs:3 use std::io::prelude::*;
                  ^~~~~~~~~~~~~~~~~~~~
src/main.rs:4:15: 4:19 warning: unused import, #[warn(unused_imports)] on by default
src/main.rs:4 use std::fs::{File,OpenOptions};
                            ^~~~
src/main.rs:15:40: 15:45 warning: unused variable: `bytes`, #[warn(unused_variables)] on by default
src/main.rs:15 fn record_entry_in_log(filename: &amp;str, bytes: &amp;[u8]) -&gt; io::Result&lt;()&gt; {
                                                      ^~~~~
src/main.rs:16:9: 16:17 warning: unused variable: `file`, #[warn(unused_variables)] on by default
src/main.rs:16     let mut file = try!(OpenOptions::new().
                       ^~~~~~~~
src/main.rs:16:9: 16:17 warning: variable does not need to be mutable, #[warn(unused_mut)] on by de
fault
src/main.rs:16     let mut file = try!(OpenOptions::new().
                       ^~~~~~~~
     Running `target/debug/simple-log`
File created!
$ ls
Cargo.lock      Cargo.toml      log.txt         src             target
</pre>

<p>
Unsurprisingly, there are a bunch unused messages, but aside from
that the file is indeed created.
</p>

<p>
It seems a little silly, but I tried adding <code>.write(true)</code> to the
chain of functions, and it worked. It seems like <code>.append(true)</code>
should imply <code>.write(true)</code>, but I guess it doesn't.
</p>

<p>
And with that, its working! The final version:
</p>

<pre class="example">
extern crate chrono;

use std::io::prelude::*;
use std::fs::{File,OpenOptions};
use std::io;
use chrono::{DateTime,Local};


fn formatted_time_entry() -&gt; String {
    let local: DateTime&lt;Local&gt; = Local::now();
    let formatted = local.format("%a, %b %d %Y %I:%M:%S %p\n").to_string();
    formatted
}

fn record_entry_in_log(filename: &amp;str, bytes: &amp;[u8]) -&gt; io::Result&lt;()&gt; {
    let mut file = try!(OpenOptions::new().
                        append(true).
                        write(true).
                        create(true).
                        open(filename));
    try!(file.write_all(bytes));
    Ok(())
}

fn log_time(filename: &amp;'static str) -&gt; io::Result&lt;()&gt; {
    let entry = formatted_time_entry();
    let bytes = entry.as_bytes();

    try!(record_entry_in_log(filename, &amp;bytes));
    Ok(())
}

fn main() {
    match log_time("log.txt") {
        Ok(..) =&gt; println!("File created!"),
        Err(e) =&gt; println!("Error: {}", e)
    }
}
</pre>

<p>
=&gt;
</p>

<pre class="example">
$ ls
Cargo.lock      Cargo.toml      src             target
$ cargo run
     Running `target/debug/simple-log`
File created!
$ cargo run
     Running `target/debug/simple-log`
File created!
$ cat log.txt
Sun, Jun 07 2015 10:40:01 PM
Sun, Jun 07 2015 10:40:05 PM
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Conclusion &amp; Next Steps</h2>
<div class="outline-text-2" id="text-5">
<p>
Rust is getting easier for me. I now have some reasonably factored
code to work with, and I feel fairly confident about starting on the
next part of the application.
</p>

<p>
When I was first planning this series, I expected the next task to be
integrating the logging code with the <code>nickel.rs</code> code, but at this
point I think it is going to be pretty simple. I suspect that the next
difficult part will be handling <a href="http://doc.rust-lang.org/getopts/getopts/index.html">option parsing</a>.
</p>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" name="fn.1" class="footnum" href="#fnr.1">1</a></sup> <p class="footpara">
Having many types of strings is a completely reasonable
thing. Strings are a
complicated subject and hard to get right.
Unfortunately, at first glance strings seem very simple, and this kind
of things seems like needless complication
</p></div>

<div class="footdef"><sup><a id="fn.2" name="fn.2" class="footnum" href="#fnr.2">2</a></sup> <p class="footpara">
I basically have no idea what I'm talking about
here. These are just things I've seen that I'm to make sense of.
</p></div>


</div>
</div>
                    </article>

                    <div id="disqus_thread"></div>
                    <script>
                     var disqus_shortname = 'joelmccracken'; // required: replace example with your forum shortname

                     var disqus_config = function () {
                         this.page.url = "http://joelmccracken.github.io/entries/a-simple-web-app-in-rust-pt-2b/";
                         this.page.identifier = "/entries/a-simple-web-app-in-rust-pt-2b";
                         this.page.title = "A Simple Web App in Rust, Part 2b";
                     };

                     (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
                         var d = document, s = d.createElement('script');

                         s.src = '//'+disqus_shortname+'.disqus.com/embed.js';  // IMPORTANT: Replace EXAMPLE with your forum shortname!
                         s.setAttribute('data-timestamp', +new Date());
                         (d.head || d.body).appendChild(s);
                     })();
                    </script>
                    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
                </div>
            </div>
        </div>

        <footer class="site-footer">

  <div class="wrap">

    <h2 class="footer-heading">Joel McCracken</h2>

    <div class="footer-col-1 column">
      <ul>
        <li><a href="mailto:mccracken.joel@gmail.com">mccracken.joel@gmail.com</a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/JoelMcCracken">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username">JoelMcCracken</span>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/JoelMcCracken">
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>
            <span class="username">JoelMcCracken</span>
          </a>
        </li>
      </ul>
    </div>

    <!-- 
    <div class="footer-col-3 column">
      <p class="text">would like to add some rotating content down here</p>
    </div>
    -->
  </div>

</footer>


        <script type="text/javascript">
 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-7759066-1']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
 })();
</script>

    </body>
</html>
