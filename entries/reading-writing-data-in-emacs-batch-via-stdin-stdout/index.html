<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Reading from stdin and writing to stdout with Emacs batch</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="Nebby about Tech">
    <link rel="canonical" href="http://joelmccracken.github.io/entries/reading-writing-data-in-emacs-batch-via-stdin-stdout/">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">
</head>


    <body>

        <header class="site-header">
  <div class="wrap">
    <a class="site-title" href="/">Joel's Journal</a>
  </div>
</header>


        <div class="page-content">
            <div class="wrap">
                <div class="post">
                    <header class="post-header">
                        <h1>Reading from stdin and writing to stdout with Emacs batch</h1>
                        <p class="meta">May 14, 2014</p>
                    </header>

                    <article class="post-content">
                        <p>So, this is something that has irritated me from time to time about
emacs. I have long thought that it was not possible to read data from stdin
from emacs when in batch mode (I had discovered that <code>(message "foo")</code>
would write foo to stdout, so that wasn’t an issue). I have tried to
search google for it in the past, but I never found what I was looking
for.</p>

<p>I have again been dealing with this problem, and finally found the
solution, which is documented at
<a href="http://www.gnu.org/software/emacs/manual/html_node/elisp/Batch-Mode.html#Batch-Mode">(info “(elisp) Batch Mode”)</a>.</p>

<p>The relvant selection is:</p>

<pre><code>Any Lisp program output that would normally go to the echo area,
either using `message', or using `prin1', etc., with `t' as the stream,
goes instead to Emacs's standard error descriptor when in batch mode.
Similarly, input that would normally come from the minibuffer is read
from the standard input descriptor.  Thus, Emacs behaves much like a
noninteractive application program.  (The echo area output that Emacs
itself normally generates, such as command echoing, is suppressed
entirely.)
</code></pre>

<p>So, we can use <code>read-from-minibuffer</code> to get data from stdin, and
<code>princ</code> to write data.</p>

<h2 id="a-real-world-example">A Real-World Example</h2>

<p>My goal was to write a plugin for Jekyll that will convert org mode
files into blog posts (which is working, but I still need to tweak
things, so that will be saved for a later post).</p>

<p>Basically, Jekyll reads the files that represents your posts, removes
yaml metadata from the head of the document, and hands the content of
the file to the converter plugin. Thus, I have the text contents of an
org file, and need to convert that to an html version. In an ideal
world, I would be able to pipe this text into emacs and have it output
the html I want.</p>

<p>The portion of elisp that implements this:</p>

<pre><code>(defun compile-org-file ()
  (interactive)
  (let ((org-document-content "")
        this-read)
    (while (setq this-read (ignore-errors
                             (read-from-minibuffer "")))
      (setq org-document-content (concat org-document-content "\n" this-read)))

    (with-temp-buffer
      (org-mode)
      (insert org-document-content)
      (org-html-export-as-html)
      (princ (buffer-string)))))
</code></pre>

<p>There are a number of things to point out, here.</p>

<p><code>read-from-minibuffer</code> was tricky, and needed some special consideration:</p>

<ul>
  <li>No prompt should be displayed to the user, since data is coming in
unprompted. Thus, an empty string argument.</li>
  <li>This function reads in a single line at a time. As data is
read in, it must be appended to what has already been read.</li>
  <li>When EOF is read, an error is thrown, which is useless to
us. Instead of worrying about the error, we can wrap the function
call in an <code>ignore-errors</code> macro, which will return <code>nil</code> when an
EOF occurs.</li>
</ul>

<p>Once the entire data is read in, we can convert it org mode.</p>

<ul>
  <li>A temporary buffer is created, which is converted to <code>org-mode</code></li>
  <li>The contents of the org document are inserted into the buffer.</li>
  <li><code>org-html-export-as-html</code> creates a new buffer, makes it current,
and inserts the exported html into that buffer.</li>
  <li><code>princ</code> writes the converted html to stdout.</li>
</ul>

<p>Overall, I am pretty happy with the solution. This is one of the
lesser known areas of Emacs, and I’m really glad that I finally know
how to do it, because it is a problem I have had to deal with on
several occasions.</p>

                    </article>

                    <div id="disqus_thread"></div>
                    <script>
                     var disqus_shortname = 'joelmccracken'; // required: replace example with your forum shortname

                     var disqus_config = function () {
                         this.page.url = "http://joelmccracken.github.io/entries/reading-writing-data-in-emacs-batch-via-stdin-stdout/";
                         this.page.identifier = "/entries/reading-writing-data-in-emacs-batch-via-stdin-stdout";
                         this.page.title = "Reading from stdin and writing to stdout with Emacs batch";
                     };

                     (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
                         var d = document, s = d.createElement('script');

                         s.src = '//'+disqus_shortname+'.disqus.com/embed.js';  // IMPORTANT: Replace EXAMPLE with your forum shortname!
                         s.setAttribute('data-timestamp', +new Date());
                         (d.head || d.body).appendChild(s);
                     })();
                    </script>
                    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
                </div>
            </div>
        </div>

        <footer class="site-footer">

  <div class="wrap">

    <h2 class="footer-heading">Joel McCracken</h2>

    <div class="footer-col-1 column">
      <ul>
        <li><a href="mailto:mccracken.joel@gmail.com">mccracken.joel@gmail.com</a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/JoelMcCracken">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username">JoelMcCracken</span>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/JoelMcCracken">
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>
            <span class="username">JoelMcCracken</span>
          </a>
        </li>
      </ul>
    </div>

    <!-- 
    <div class="footer-col-3 column">
      <p class="text">would like to add some rotating content down here</p>
    </div>
    -->
  </div>

</footer>


        <script type="text/javascript">
 var _gaq = _gaq || [];
 _gaq.push(['_setAccount', 'UA-7759066-1']);
 _gaq.push(['_trackPageview']);

 (function() {
   var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
 })();
</script>

    </body>
</html>
